CREATE OR REPLACE PROCEDURE SP_PUBLISH_DATASET()
RETURNS VARIANT
LANGUAGE SQL
AS
DECLARE
    TABLES RESULTSET DEFAULT(select table_name from control_stream);
BEGIN

    FOR tbl IN tables DO
        //drop all published files to internal stage
        execute immediate ( 'copy into @published_extracts/' + 
        tbl.table_name + '.csv from ' + 
        tbl.table_name + ' SINGLE = TRUE MAX_FILE_SIZE=5368709120 OVERWRITE=TRUE file_format = (TYPE = csv COMPRESSION = none FIELD_OPTIONALLY_ENCLOSED_BY=''\042'');');
    END FOR;
    
    //make the api call. Updates packageid
    execute immediate ('UPDATE CONTROL set package_id = EXT_PACKAGE_ID FROM (select package_create(lower(table_name),notes,accesslevel,contact_name,contact_email,rights  ,accrualperiodicity,tag_string  ,owner_org) EXT_PACKAGE_ID, TABLE_NAME, METADATA$ISUPDATE ISUPDATE from control_Stream) STRM WHERE CONTROL.TABLE_NAME = STRM.TABLE_NAME AND ISUPDATE = FALSE;');

    execute immediate ( 'insert into ckan_log select sysdate(),package_id,table_name from control_Stream;');
    
END;